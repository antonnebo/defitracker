<div class="page-container">
  <!-- Header -->
  <header class="page-header">
    <%= link_to "DeFi Tracker", dashboard_path, class: "page-logo" %>
    <nav class="page-nav">
      <%= link_to "Dashboard", dashboard_path, class: "nav-link" %>
      <%= link_to "Accounts", accounts_path, class: "nav-link active" %>
      <% if Current.session %>
        <%= button_to "Выйти", session_path, method: :delete, class: "btn btn-outline" %>
      <% end %>
    </nav>
  </header>

  <% if flash[:notice] %>
    <div class="flash flash-notice">
      <%= flash[:notice] %>
    </div>
  <% end %>

  <!-- Back Button & Page Title -->
  <div style="margin-bottom: 24px;">
    <%= link_to accounts_path, style: "display: inline-flex; align-items: center; gap: 8px; color: var(--color-text-secondary); text-decoration: none; transition: color 0.2s ease;" do %>
      <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
      <span>Back to Accounts</span>
    <% end %>
  </div>

  <!-- Account Header -->
  <div style="margin-bottom: 32px;">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px; margin-bottom: 16px;">
      <div>
        <h1 style="margin-bottom: 12px;"><%= @account.display_name %></h1>
        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
          <div style="display: flex; align-items: center; gap: 8px; font-family: 'Monaco', 'Courier New', monospace; font-size: 0.875rem; color: var(--color-text-secondary); background: var(--color-bg-secondary); padding: 8px 12px; border-radius: var(--radius-sm); border: 1px solid var(--color-border);">
            <span><%= @account.address %></span>
            <button onclick="navigator.clipboard.writeText('<%= @account.address %>')" style="background: none; border: none; cursor: pointer; padding: 0; color: var(--color-text-tertiary); transition: color 0.2s ease;" title="Copy address">
              <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
            </button>
          </div>
          <% if @account.account_type %>
            <span style="display: inline-flex; align-items: center; padding: 6px 12px; background: var(--color-bg-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: 0.875rem; color: var(--color-text-secondary);">
              <%= @account.account_type %>
            </span>
          <% end %>
          <% if @account.last_synced_at %>
            <span style="font-size: 0.875rem; color: var(--color-text-tertiary);">
              Last synced: <%= time_ago_in_words(@account.last_synced_at) %> ago
            </span>
          <% end %>
        </div>
      </div>
      <div style="display: flex; gap: 12px;">
        <%= link_to edit_account_path(@account), class: "btn btn-secondary" do %>
          <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
          </svg>
          <span>Edit</span>
        <% end %>
        <%= button_to sync_account_path(@account), method: :post,
            class: "btn btn-primary",
            disabled: @account.sync_status == "syncing",
            data: { turbo: false } do %>
          <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          <span>Re-sync</span>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Sync Status Alert -->
  <% if @account.sync_status == "syncing" %>
    <div class="card" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); margin-bottom: 24px;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <svg style="width: 20px; height: 20px; color: #3B82F6; animation: spin 1s linear infinite;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        <span style="color: #3B82F6; font-weight: 500;">Syncing account data...</span>
      </div>
    </div>
  <% elsif @account.sync_status == "error" %>
    <div class="card" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); margin-bottom: 24px;">
      <div style="display: flex; align-items: flex-start; gap: 12px;">
        <svg style="width: 20px; height: 20px; color: #EF4444; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div>
          <span style="color: #EF4444; font-weight: 500; display: block; margin-bottom: 4px;">Sync Error</span>
          <% if @account.sync_error %>
            <span style="color: #FCA5A5; font-size: 0.875rem;"><%= @account.sync_error %></span>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Portfolio Overview Cards -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 32px;">
    <!-- Total Balance Card -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
        <div>
          <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: 8px;">Total Balance</p>
          <p style="font-size: 2rem; font-weight: 700; font-family: var(--font-display); color: var(--color-text-primary);">
            $<%= number_with_delimiter(@account.balance_usd.round(2), delimiter: ",") %>
          </p>
        </div>
        <div style="width: 48px; height: 48px; background: rgba(59, 130, 246, 0.1); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center;">
          <svg style="width: 24px; height: 24px; color: #3B82F6;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path>
          </svg>
        </div>
      </div>
      <div style="display: flex; gap: 16px; padding-top: 16px; border-top: 1px solid var(--color-border);">
        <div style="flex: 1;">
          <p style="font-size: 0.75rem; color: var(--color-text-tertiary); margin-bottom: 4px;">Wallet</p>
          <p style="font-size: 0.875rem; font-weight: 600; color: var(--color-text-secondary);"><%= @wallet_percentage %>%</p>
        </div>
        <div style="flex: 1;">
          <p style="font-size: 0.75rem; color: var(--color-text-tertiary); margin-bottom: 4px;">Protocols</p>
          <p style="font-size: 0.875rem; font-weight: 600; color: var(--color-text-secondary);"><%= @protocol_percentage %>%</p>
        </div>
      </div>
    </div>

    <!-- Wallet Balance Card -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
        <div>
          <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: 8px;">Wallet Balance</p>
          <p style="font-size: 2rem; font-weight: 700; font-family: var(--font-display); color: var(--color-text-primary);">
            $<%= number_with_delimiter(@account.wallet_balance_usd.round(2), delimiter: ",") %>
          </p>
        </div>
        <div style="width: 48px; height: 48px; background: rgba(16, 185, 129, 0.1); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center;">
          <svg style="width: 24px; height: 24px; color: #10B981;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
          </svg>
        </div>
      </div>
      <p style="font-size: 0.75rem; color: var(--color-text-tertiary); padding-top: 16px; border-top: 1px solid var(--color-border);">
        Direct holdings in wallet
      </p>
    </div>

    <!-- Protocol Balance Card -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
        <div>
          <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: 8px;">Protocol Balance</p>
          <p style="font-size: 2rem; font-weight: 700; font-family: var(--font-display); color: var(--color-text-primary);">
            $<%= number_with_delimiter(@account.protocol_balance_usd.round(2), delimiter: ",") %>
          </p>
        </div>
        <div style="width: 48px; height: 48px; background: rgba(168, 85, 247, 0.1); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center;">
          <svg style="width: 24px; height: 24px; color: #A855F7;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
          </svg>
        </div>
      </div>
      <p style="font-size: 0.75rem; color: var(--color-text-tertiary); padding-top: 16px; border-top: 1px solid var(--color-border);">
        Staked, lent, and LP positions
      </p>
    </div>
  </div>

  <!-- DeFi Positions Section -->
  <div style="margin-bottom: 24px;">
    <h2 style="margin-bottom: 16px;">DeFi Positions</h2>
    <% if @defi_positions.empty? %>
      <!-- Empty State -->
      <div class="card" style="text-align: center; padding: 80px 20px;">
        <svg style="width: 64px; height: 64px; color: var(--color-text-tertiary); opacity: 0.3; margin: 0 auto 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
        </svg>
        <p style="font-size: 1.25rem; font-weight: 600; margin-bottom: 8px;">No DeFi positions found</p>
        <p style="color: var(--color-text-secondary);">This wallet has no active positions in DeFi protocols</p>
      </div>
    <% else %>
      <!-- Protocol Cards -->
      <% sorted_protocols = @defi_positions.sort_by { |protocol|
           -protocol["positions"].sum { |p| p["usd_value"].to_f }
         }
      %>
      <% sorted_protocols.each_with_index do |protocol, index| %>
        <%= render "accounts/defi_protocol_card", protocol: protocol, index: index %>
      <% end %>
    <% end %>
  </div>
</div>

<style>
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Back link hover */
  a[href*="accounts"]:hover {
    color: var(--color-accent-primary) !important;
  }

  /* Copy button hover */
  button[onclick*="clipboard"]:hover {
    color: var(--color-accent-primary) !important;
  }
</style>
