<div class="page-container">
  <!-- Header -->
  <header class="page-header">
    <%= link_to "DeFi Tracker", dashboard_path, class: "page-logo" %>
    <nav class="page-nav">
      <%= link_to "Dashboard", dashboard_path, class: "nav-link" %>
      <%= link_to "Accounts", accounts_path, class: "nav-link active" %>
      <% if Current.session %>
        <%= button_to "Выйти", session_path, method: :delete, class: "btn btn-outline" %>
      <% end %>
    </nav>
  </header>

  <% if flash[:notice] %>
    <div class="flash flash-notice">
      <%= flash[:notice] %>
    </div>
  <% end %>

  <!-- Back Button & Page Title -->
  <div style="margin-bottom: 24px;">
    <%= link_to accounts_path, style: "display: inline-flex; align-items: center; gap: 8px; color: var(--color-text-secondary); text-decoration: none; transition: color 0.2s ease;" do %>
      <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
      <span>Back to Accounts</span>
    <% end %>
  </div>

  <!-- Account Header -->
  <div style="margin-bottom: 32px;">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px; margin-bottom: 16px;">
      <div>
        <h1 style="margin-bottom: 12px;"><%= @account.display_name %></h1>
        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
          <div style="display: flex; align-items: center; gap: 8px; font-family: 'Monaco', 'Courier New', monospace; font-size: 0.875rem; color: var(--color-text-secondary); background: var(--color-bg-secondary); padding: 8px 12px; border-radius: var(--radius-sm); border: 1px solid var(--color-border);">
            <span><%= @account.address %></span>
            <button onclick="navigator.clipboard.writeText('<%= @account.address %>')" style="background: none; border: none; cursor: pointer; padding: 0; color: var(--color-text-tertiary); transition: color 0.2s ease;" title="Copy address">
              <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
            </button>
          </div>
          <% if @account.account_type %>
            <span style="display: inline-flex; align-items: center; padding: 6px 12px; background: var(--color-bg-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: 0.875rem; color: var(--color-text-secondary);">
              <%= @account.account_type %>
            </span>
          <% end %>
          <% if @account.last_synced_at %>
            <span style="font-size: 0.875rem; color: var(--color-text-tertiary);">
              Last synced: <%= time_ago_in_words(@account.last_synced_at) %> ago
            </span>
          <% end %>
        </div>
      </div>
      <div style="display: flex; gap: 12px;">
        <%= link_to edit_account_path(@account), class: "btn btn-secondary" do %>
          <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
          </svg>
          <span>Edit</span>
        <% end %>
        <%= button_to "#", method: :post, class: "btn btn-primary" do %>
          <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          <span>Re-sync</span>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Sync Status Alert -->
  <% if @account.sync_status == "syncing" %>
    <div class="card" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); margin-bottom: 24px;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <svg style="width: 20px; height: 20px; color: #3B82F6; animation: spin 1s linear infinite;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        <span style="color: #3B82F6; font-weight: 500;">Syncing account data...</span>
      </div>
    </div>
  <% elsif @account.sync_status == "error" %>
    <div class="card" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); margin-bottom: 24px;">
      <div style="display: flex; align-items: flex-start; gap: 12px;">
        <svg style="width: 20px; height: 20px; color: #EF4444; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div>
          <span style="color: #EF4444; font-weight: 500; display: block; margin-bottom: 4px;">Sync Error</span>
          <% if @account.sync_error %>
            <span style="color: #FCA5A5; font-size: 0.875rem;"><%= @account.sync_error %></span>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Portfolio Overview Cards -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 32px;">
    <!-- Total Balance Card -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
        <div>
          <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: 8px;">Total Balance</p>
          <p style="font-size: 2rem; font-weight: 700; font-family: var(--font-display); color: var(--color-text-primary);">
            $<%= number_with_delimiter(@account.balance_usd.round(2), delimiter: ",") %>
          </p>
        </div>
        <div style="width: 48px; height: 48px; background: rgba(59, 130, 246, 0.1); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center;">
          <svg style="width: 24px; height: 24px; color: #3B82F6;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path>
          </svg>
        </div>
      </div>
      <div style="display: flex; gap: 16px; padding-top: 16px; border-top: 1px solid var(--color-border);">
        <div style="flex: 1;">
          <p style="font-size: 0.75rem; color: var(--color-text-tertiary); margin-bottom: 4px;">Wallet</p>
          <p style="font-size: 0.875rem; font-weight: 600; color: var(--color-text-secondary);"><%= @wallet_percentage %>%</p>
        </div>
        <div style="flex: 1;">
          <p style="font-size: 0.75rem; color: var(--color-text-tertiary); margin-bottom: 4px;">Protocols</p>
          <p style="font-size: 0.875rem; font-weight: 600; color: var(--color-text-secondary);"><%= @protocol_percentage %>%</p>
        </div>
      </div>
    </div>

    <!-- Wallet Balance Card -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
        <div>
          <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: 8px;">Wallet Balance</p>
          <p style="font-size: 2rem; font-weight: 700; font-family: var(--font-display); color: var(--color-text-primary);">
            $<%= number_with_delimiter(@account.wallet_balance_usd.round(2), delimiter: ",") %>
          </p>
        </div>
        <div style="width: 48px; height: 48px; background: rgba(16, 185, 129, 0.1); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center;">
          <svg style="width: 24px; height: 24px; color: #10B981;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
          </svg>
        </div>
      </div>
      <p style="font-size: 0.75rem; color: var(--color-text-tertiary); padding-top: 16px; border-top: 1px solid var(--color-border);">
        Direct holdings in wallet
      </p>
    </div>

    <!-- Protocol Balance Card -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
        <div>
          <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: 8px;">Protocol Balance</p>
          <p style="font-size: 2rem; font-weight: 700; font-family: var(--font-display); color: var(--color-text-primary);">
            $<%= number_with_delimiter(@account.protocol_balance_usd.round(2), delimiter: ",") %>
          </p>
        </div>
        <div style="width: 48px; height: 48px; background: rgba(168, 85, 247, 0.1); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center;">
          <svg style="width: 24px; height: 24px; color: #A855F7;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
          </svg>
        </div>
      </div>
      <p style="font-size: 0.75rem; color: var(--color-text-tertiary); padding-top: 16px; border-top: 1px solid var(--color-border);">
        Staked, lent, and LP positions
      </p>
    </div>
  </div>

  <!-- DeFi Positions Section -->
  <div style="margin-bottom: 24px;">
    <h2 style="margin-bottom: 16px;">DeFi Positions</h2>
    <% if @defi_positions.empty? %>
      <!-- Empty State -->
      <div class="card" style="text-align: center; padding: 80px 20px;">
        <svg style="width: 64px; height: 64px; color: var(--color-text-tertiary); opacity: 0.3; margin: 0 auto 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
        </svg>
        <p style="font-size: 1.25rem; font-weight: 600; margin-bottom: 8px;">No DeFi positions found</p>
        <p style="color: var(--color-text-secondary);">This wallet has no active positions in DeFi protocols</p>
      </div>
    <% else %>
      <!-- Positions Table -->
      <div class="card" style="padding: 0; overflow: hidden;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 1px solid var(--color-border);">
              <th style="text-align: left; padding: 16px 20px; font-size: 0.875rem; font-weight: 600; color: var(--color-text-secondary);">Protocol</th>
              <th style="text-align: left; padding: 16px 20px; font-size: 0.875rem; font-weight: 600; color: var(--color-text-secondary);">Type</th>
              <th style="text-align: left; padding: 16px 20px; font-size: 0.875rem; font-weight: 600; color: var(--color-text-secondary);">Positions</th>
              <th style="text-align: right; padding: 16px 20px; font-size: 0.875rem; font-weight: 600; color: var(--color-text-secondary);">Total Value</th>
              <th style="width: 48px;"></th>
            </tr>
          </thead>
          <tbody>
            <% @defi_positions.sort_by { |protocol| -protocol["positions"].sum { |p| p["usd_value"].to_f } }.each_with_index do |protocol, index| %>
              <% protocol_value = protocol["positions"].sum { |p| p["usd_value"].to_f } %>
              <tr style="border-bottom: 1px solid var(--color-border); transition: background 0.2s ease;" data-protocol-row="<%= index %>">
                <td style="padding: 16px 20px;">
                  <span style="font-weight: 600; color: var(--color-text-primary);"><%= protocol["name"] %></span>
                </td>
                <td style="padding: 16px 20px;">
                  <span style="display: inline-flex; align-items: center; padding: 4px 10px; background: var(--color-bg-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: 0.75rem; color: var(--color-text-secondary); text-transform: capitalize;">
                    <%= protocol["type"] %>
                  </span>
                </td>
                <td style="padding: 16px 20px; color: var(--color-text-secondary);">
                  <%= protocol["positions"].length %> <%= protocol["positions"].length == 1 ? "position" : "positions" %>
                </td>
                <td style="padding: 16px 20px; text-align: right; font-weight: 600; font-family: var(--font-display);">
                  <span style="color: <%= protocol_value >= 0 ? 'var(--color-text-primary)' : '#EF4444' %>;">
                    <%= protocol_value >= 0 ? '' : '-' %>$<%= number_with_delimiter(protocol_value.abs.round(2), delimiter: ",") %>
                  </span>
                </td>
                <td style="padding: 16px 20px;">
                  <button onclick="toggleProtocol(<%= index %>)" style="color: var(--color-text-secondary); background: none; border: none; cursor: pointer; padding: 4px; transition: transform 0.2s ease;" data-toggle-btn="<%= index %>">
                    <svg style="width: 20px; height: 20px; transform: rotate(0deg); transition: transform 0.2s ease;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </button>
                </td>
              </tr>
              <!-- Expandable Positions Detail -->
              <tr style="display: none; border-bottom: 1px solid var(--color-border);" data-protocol-detail="<%= index %>">
                <td colspan="5" style="padding: 0; background: var(--color-bg-secondary);">
                  <div style="padding: 20px;">
                    <div style="display: grid; gap: 12px;">
                      <% protocol["positions"].each do |position| %>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--color-bg-primary); border: 1px solid var(--color-border); border-radius: var(--radius-sm);">
                          <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                              <span style="font-weight: 600; color: var(--color-text-primary);"><%= position["token_symbol"] %></span>
                              <% if position["chain"] %>
                                <span style="font-size: 0.75rem; color: var(--color-text-tertiary); text-transform: uppercase;"><%= position["chain"] %></span>
                              <% end %>
                              <% if position["is_debt"] %>
                                <span style="display: inline-flex; align-items: center; padding: 2px 6px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: var(--radius-sm); font-size: 0.75rem; color: #EF4444;">
                                  DEBT
                                </span>
                              <% end %>
                            </div>
                            <p style="font-size: 0.875rem; color: var(--color-text-secondary);"><%= position["token_name"] %></p>
                          </div>
                          <div style="text-align: right;">
                            <p style="font-weight: 600; color: var(--color-text-primary); margin-bottom: 4px;"><%= number_with_delimiter(position["balance"].to_f.round(6), delimiter: ",") %></p>
                            <p style="font-size: 0.875rem; font-weight: 600; font-family: var(--font-display); color: <%= position["usd_value"].to_f >= 0 ? 'var(--color-text-secondary)' : '#EF4444' %>;">
                              <%= position["usd_value"].to_f >= 0 ? '' : '-' %>$<%= number_with_delimiter(position["usd_value"].to_f.abs.round(2), delimiter: ",") %>
                            </p>
                          </div>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  </div>
</div>

<style>
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Hover effects for table rows */
  tbody tr[data-protocol-row]:hover {
    background: rgba(255, 255, 255, 0.02) !important;
    cursor: pointer;
  }

  /* Hover effect for toggle button */
  tbody button:hover {
    color: var(--color-accent-primary) !important;
  }

  /* Back link hover */
  a[href*="accounts"]:hover {
    color: var(--color-accent-primary) !important;
  }

  /* Copy button hover */
  button[onclick*="clipboard"]:hover {
    color: var(--color-accent-primary) !important;
  }
</style>

<script>
  function toggleProtocol(index) {
    const detailRow = document.querySelector(`tr[data-protocol-detail="${index}"]`);
    const toggleBtn = document.querySelector(`button[data-toggle-btn="${index}"] svg`);

    if (detailRow.style.display === 'none' || detailRow.style.display === '') {
      detailRow.style.display = 'table-row';
      toggleBtn.style.transform = 'rotate(180deg)';
    } else {
      detailRow.style.display = 'none';
      toggleBtn.style.transform = 'rotate(0deg)';
    }
  }

  // Make protocol rows clickable
  document.querySelectorAll('tr[data-protocol-row]').forEach(row => {
    row.addEventListener('click', (e) => {
      // Don't toggle if clicking the button directly
      if (e.target.closest('button')) return;
      const index = row.getAttribute('data-protocol-row');
      toggleProtocol(index);
    });
  });
</script>
