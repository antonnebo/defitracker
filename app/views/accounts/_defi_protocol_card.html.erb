<%
  # Local variables expected:
  # - protocol: Hash with name, type, positions array
  # - index: Integer (for unique IDs if needed)

  # Calculate total USD value (sum all positions) - this is the NET value
  total_usd = protocol["positions"].sum { |p| p["usd_value"].to_f }

  # Group positions into supplied and borrowed
  # Handle both is_debt field and fallback to negative usd_value
  supplied = protocol["positions"].select { |p|
    !(p["is_debt"] || false) && (p["usd_value"].to_f >= 0)
  }
  borrowed = protocol["positions"].select { |p|
    (p["is_debt"] || false) || (p["usd_value"].to_f < 0)
  }

  # Calculate totals for display
  supplied_total = supplied.sum { |p| p["usd_value"].to_f }
  borrowed_total = borrowed.sum { |p| p["usd_value"].to_f.abs } # Abs for display as positive

  # Health rate (if available from protocol data)
  health_rate = protocol["health_rate"]

  # Detect multi-chain (check if positions have different chain values)
  chains = protocol["positions"].map { |p| p["chain"] }.uniq
  is_multichain = chains.length > 1
%>

<div class="card" style="margin-bottom: 16px;">
  <!-- Protocol Header -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <div style="display: flex; align-items: center; gap: 12px;">
      <!-- Protocol Icon Placeholder -->
      <div style="width: 40px; height: 40px; background: rgba(168, 85, 247, 0.1); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(168, 85, 247, 0.2);">
        <svg style="width: 20px; height: 20px; color: rgba(168, 85, 247, 0.7);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
        </svg>
      </div>

      <!-- Protocol Name -->
      <span style="font-weight: 700; font-size: 1.25rem; color: var(--color-text-primary); font-family: var(--font-display);">
        <%= protocol["name"] %>
      </span>

      <!-- Type Badge -->
      <span style="display: inline-flex; align-items: center; padding: 4px 10px; background: var(--color-bg-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-sm); font-size: 0.75rem; color: var(--color-text-secondary); text-transform: capitalize;">
        <%= protocol["type"] %>
      </span>
    </div>

    <!-- Net Value & Health Rate -->
    <div style="text-align: right; display: flex; flex-direction: column; gap: 8px;">
      <!-- Net Value -->
      <div>
        <p style="font-size: 0.75rem; color: var(--color-text-tertiary); margin: 0 0 4px 0; text-transform: uppercase; letter-spacing: 0.05em;">Net Value</p>
        <p style="font-size: 1.5rem; font-weight: 700; font-family: var(--font-display); color: <%= total_usd >= 0 ? 'var(--color-text-primary)' : '#EF4444' %>; margin: 0;">
          <%= total_usd >= 0 ? '' : '-' %>$<%= number_with_delimiter(total_usd.abs.round(2), delimiter: ",") %>
        </p>
      </div>

      <!-- Health Rate (if available) -->
      <% if health_rate %>
        <div style="display: flex; align-items: center; gap: 8px; justify-content: flex-end;">
          <span style="font-size: 0.75rem; color: var(--color-text-tertiary); text-transform: uppercase; letter-spacing: 0.05em;">Health Rate:</span>
          <span style="font-size: 0.875rem; font-weight: 600; color: <%= health_rate.to_f >= 1.5 ? 'var(--color-accent-primary)' : (health_rate.to_f >= 1.2 ? '#F59E0B' : '#EF4444') %>;">
            <%= number_with_delimiter(health_rate.to_f.round(2), delimiter: ",") %>
          </span>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Summary Stats (Supplied vs Borrowed) -->
  <% if supplied.any? && borrowed.any? %>
    <div style="display: flex; gap: 24px; padding: 12px 16px; background: var(--color-bg-secondary); border-radius: var(--radius-sm); margin-bottom: 20px;">
      <div style="flex: 1;">
        <p style="font-size: 0.75rem; color: var(--color-text-tertiary); margin: 0 0 4px 0; text-transform: uppercase; letter-spacing: 0.05em;">Supplied</p>
        <p style="font-size: 1.125rem; font-weight: 600; font-family: var(--font-display); color: var(--color-text-primary); margin: 0;">
          $<%= number_with_delimiter(supplied_total.round(2), delimiter: ",") %>
        </p>
      </div>
      <div style="flex: 1;">
        <p style="font-size: 0.75rem; color: var(--color-text-tertiary); margin: 0 0 4px 0; text-transform: uppercase; letter-spacing: 0.05em;">Borrowed</p>
        <p style="font-size: 1.125rem; font-weight: 600; font-family: var(--font-display); color: #EF4444; margin: 0;">
          $<%= number_with_delimiter(borrowed_total.round(2), delimiter: ",") %>
        </p>
      </div>
      <% if health_rate && borrowed.any? %>
        <div style="flex: 1;">
          <p style="font-size: 0.75rem; color: var(--color-text-tertiary); margin: 0 0 4px 0; text-transform: uppercase; letter-spacing: 0.05em;">Health Rate</p>
          <p style="font-size: 1.125rem; font-weight: 600; font-family: var(--font-display); color: <%= health_rate.to_f >= 1.5 ? 'var(--color-accent-primary)' : (health_rate.to_f >= 1.2 ? '#F59E0B' : '#EF4444') %>; margin: 0;">
            <%= number_with_delimiter(health_rate.to_f.round(2), delimiter: ",") %>
          </p>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Protocol Body: Supplied and Borrowed Sections -->
  <% if supplied.any? %>
    <%= render "accounts/defi_position_group",
               positions: supplied,
               title: "Supplied",
               is_debt: false,
               is_multichain: is_multichain %>
  <% end %>

  <% if borrowed.any? %>
    <%= render "accounts/defi_position_group",
               positions: borrowed,
               title: "Borrowed",
               is_debt: true,
               is_multichain: is_multichain %>
  <% end %>
</div>
